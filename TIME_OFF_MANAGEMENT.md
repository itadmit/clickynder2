# ניהול חופשים וחגים 🏖️

מערכת מקיפה לניהול חופשים של עובדים וחגים עסקיים במערכת Clickynder.

## תכונות 🎯

### 1. חופשים אישיים של עובדים
- **ניהול מלא** של חופשים לכל עובד
- **טווח תאריכים** - חופשה יכולה להיות יום אחד או מספר ימים
- **סיבה** - אפשרות לציין סיבה (חופשה, מחלה, וכו')
- **מצב ויזואלי** - הצגה ברורה של חופשים עתידיים, פעילים כעת, ועבר
- **עריכה ומחיקה** - ניהול קל של חופשים קיימים

### 2. חגים עסקיים
- **חגים מוכנים מראש** - רשימת חגים ישראליים נפוצים
- **חגים חוזרים** - סימון חגים שחוזרים כל שנה
- **ניהול מרכזי** - הגדרת חגים ברמת העסק (משפיע על כל העובדים)

### 3. השפעה על הזמנת תורים
- **חסימת תאריכים** - תאריכים בחופש/חג לא מוצגים כזמינים
- **הודעות ברורות** - המערכת מסבירה מדוע לא ניתן לקבוע תור
- **בדיקה כפולה** - גם ב-API של slots וגם ב-API של booking

## שימוש 📱

### ניהול חופשים של עובד

1. עבור לדף **עובדים** בדשבורד
2. בכרטיס של כל עובד, לחץ על כפתור **📅** (ניהול חופשים)
3. במודל שנפתח:
   - **הוספת חופשה חדשה:**
     - בחר תאריך התחלה
     - בחר תאריך סיום
     - הוסף סיבה (אופציונלי)
     - לחץ "הוסף חופשה"
   - **עריכת חופשה:**
     - לחץ על אייקון העריכה ✏️
     - שנה את הפרטים
     - לחץ "עדכן"
   - **מחיקת חופשה:**
     - לחץ על אייקון הפח 🗑️
     - אשר מחיקה

### ניהול חגים עסקיים

1. עבור ל**הגדרות** → טאב **ימי ושעות עבודה**
2. גלול למטה ל**חגים וימים לא עובדים**
3. **הוספת חג:**
   - הזן שם החג
   - בחר תאריך
   - סמן "חג חוזר" אם החג חוזר כל שנה
   - לחץ "הוסף חג"
4. **שימוש בחגים מוכנים:**
   - לחץ "חגים מוכנים"
   - בחר חג מהרשימה
   - הפרטים יתמלאו אוטומטית
   - לחץ "הוסף חג"

## מבנה טכני 🏗️

### מסד נתונים

**טבלה: `time_off`**
```prisma
model TimeOff {
  id         String       @id @default(cuid())
  businessId String       @map("business_id")
  scope      TimeOffScope // business, branch, staff
  branchId   String?      @map("branch_id")
  staffId    String?      @map("staff_id")
  startAt    DateTime     @map("start_at")
  endAt      DateTime     @map("end_at")
  reason     String?
}

enum TimeOffScope {
  business  // חג עסקי (כל העסק)
  branch    // חופשת סניף (עתיד)
  staff     // חופשת עובד אישית
}
```

### API Endpoints

#### GET `/api/time-off`
קבלת חופשים/חגים
- **Query Params:**
  - `businessId` (required)
  - `staffId` (optional) - לסינון לפי עובד
  - `branchId` (optional) - לסינון לפי סניף
  - `scope` (optional) - `business`, `branch`, `staff`

#### POST `/api/time-off`
יצירת חופש/חג חדש
- **Body:**
```json
{
  "businessId": "xxx",
  "scope": "staff",
  "staffId": "xxx",
  "startAt": "2024-12-25T00:00:00Z",
  "endAt": "2024-12-26T00:00:00Z",
  "reason": "חופשה"
}
```

#### PUT `/api/time-off/:id`
עדכון חופש/חג
- **Body:**
```json
{
  "startAt": "2024-12-25T00:00:00Z",
  "endAt": "2024-12-27T00:00:00Z",
  "reason": "חופשה מורחבת"
}
```

#### DELETE `/api/time-off/:id`
מחיקת חופש/חג

### קומפוננטים

#### `TimeOffModal.tsx`
- מודל לניהול חופשים של עובד ספציפי
- מוצג מתוך דף העובדים
- כולל טופס הוספה/עריכה ורשימת חופשים קיימים

#### `HolidaysSettings.tsx`
- רכיב בעמוד ההגדרות לניהול חגים עסקיים
- כולל רשימת חגים ישראליים מוכנים מראש
- תמיכה בחגים חוזרים

### לוגיקת בדיקת זמינות

הלוגיקה ב-`/api/appointments/slots` וב-`/api/appointments/book` בודקת:

1. **חגים עסקיים** (`scope: business`)
   - אם יש חג בתאריך המבוקש → אין slots זמינים
   
2. **חופשים של עובד** (`scope: staff`)
   - אם העובד בחופשה בתאריך המבוקש → אין slots זמינים לעובד זה

**דוגמה:**
```typescript
// בדיקת חג עסקי
const businessTimeOff = await prisma.timeOff.findFirst({
  where: {
    businessId,
    scope: 'business',
    startAt: { lte: endOfDay },
    endAt: { gte: startOfDay },
  },
});

if (businessTimeOff) {
  return NextResponse.json({ slots: [], reason: 'holiday' });
}

// בדיקת חופש עובד
if (staffId) {
  const staffTimeOff = await prisma.timeOff.findFirst({
    where: {
      staffId,
      scope: 'staff',
      startAt: { lte: endOfDay },
      endAt: { gte: startOfDay },
    },
  });

  if (staffTimeOff) {
    return NextResponse.json({ slots: [], reason: 'staff_unavailable' });
  }
}
```

## חגים ישראליים מוכנים 🇮🇱

המערכת כוללת רשימה של חגים נפוצים:
- ראש השנה (יום א' + יום ב')
- יום כיפור
- סוכות
- שמחת תורה
- פסח (יום א' + שביעי)
- שבועות
- יום העצמאות

**הערה:** התאריכים הללו הם דוגמאות. לחגים עבריים צריך לעדכן את התאריכים מדי שנה (או להשתמש בספרייה להמרת תאריכים עבריים).

## תרחישים נפוצים 💼

### תרחיש 1: עובד בחופשה
1. מנהל מגדיר חופשה לעובד דרך המודל
2. לקוח מנסה לקבוע תור עם העובד בתאריך החופש
3. המערכת לא מציגה שעות זמינות לעובד זה
4. אם יש עובדים אחרים, הלקוח יכול לבחור בהם

### תרחיש 2: חג עסקי
1. מנהל מגדיר חג ברמת העסק (למשל יום כיפור)
2. לקוח מנסה לקבוע תור בתאריך הח ג
3. המערכת לא מציגה תאריכים זמינים כלל
4. הלקוח בוחר תאריך אחר

### תרחיש 3: חגים חוזרים
1. מנהל מגדיר חג חוזר (למשל יום העצמאות)
2. בכל שנה, באותו תאריך, המערכת תחסום תורים
3. אין צורך להזין מחדש את החג כל שנה

## שיפורים עתידיים 🚀

- [ ] **אינטגרציה עם לוח שנה עברי** - חישוב אוטומטי של חגים עבריים
- [ ] **תמיכה בחופשות סניף** - חסימת תורים לסניף שלם
- [ ] **ייצוא/ייבוא חופשים** - ייצוא לקובץ Excel/CSV
- [ ] **התראות** - התראה למנהל כאשר עובד מבקש חופשה (במקרה של אינטגרציה עם מערכת הרשאות)
- [ ] **סטטיסטיקות** - דוחות על חופשים (כמה ימים בשנה, וכו')
- [ ] **אישור חופשים** - מערכת אישורים למנהלים
- [ ] **תזכורות** - תזכורת למנהל על עובדים שבחופשה בימים הקרובים

## מיגרציה

הפיצ'ר יצר מיגרציה חדשה:
```
20251018093435_add_business_to_timeoff_scope
```

המיגרציה מוסיפה את הערך `business` ל-enum `TimeOffScope`.

## נגישות ו-UX ♿

- **צבעים ויזואליים:**
  - 🟦 כחול - חופש עתידי
  - 🟧 כתום - חופש פעיל כעת
  - ⚪ אפור - חופש עבר
  
- **אייקונים:**
  - 📅 Calendar - ניהול חופשים
  - ✏️ Edit - עריכה
  - 🗑️ Trash - מחיקה
  
- **הודעות שגיאה ברורות:**
  - "העסק לא פעיל בתאריך זה" - במקרה של חג
  - "העובד אינו זמין בתאריך זה" - במקרה של חופשה

---

**נוצר:** אוקטובר 2024  
**גרסה:** 1.0  
**מפתח:** Clickynder Team 🎉

