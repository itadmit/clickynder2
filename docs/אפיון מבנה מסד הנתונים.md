postgress
Clickinder (כמו Calendly), מותאמת רב-דיירים (multi-tenant), עם חבילות, סניפים, עובדים, שירותים, זמינות, חופשות, תורים, התראות ותשלומים (PayPlus). הדגש הוא על אינדקסים נכונים, קשרים ברורים ויכולת התרחבות.

עקרונות

MySQL 8 / InnoDB / utf8mb4

כל ישות עסקית מכילה business_id (רב-דיירים).

Soft-delete עם deleted_at היכן שנדרש.

זמנים ב-UTC, המרה ביישום לפי timezone של העסק.

אינדקסים לתורים לפי (business_id, branch_id, staff_id, start_at).

מגבלות חבילה נאכפות ברמת יישום + טבלת Usage.

ליבה: משתמשים ועסקים
users

id PK

name, email (UNIQUE), phone

password_hash

created_at, updated_at, last_login_at

אינדקס: email

businesses

id PK

owner_user_id FK→users.id

name, slug (UNIQUE per platform)

description, phone, email

timezone (e.g., Asia/Jerusalem)

locale (e.g., he-IL)

מיתוג: logo_url, primary_color, secondary_color, font = 'Noto Sans Hebrew'

הגדרות: show_branches (BOOL), show_staff (BOOL), online_payment_enabled (BOOL)

created_at, updated_at, deleted_at

business_members (הרשאות)

id PK

business_id FK

user_id FK

role ENUM('owner','admin','manager','staff','viewer')

UNIQUE(business_id,user_id)

created_at

חבילות, מנויים ושימוש
packages (תמחור ותקרות)

id PK

code ENUM('starter','pro','ultra','enterprise') UNIQUE

name

מגבלות: max_branches, max_staff, monthly_appointments_cap

מחיר חודשי: price_cents (לנוחות)

features_json (דגלים/יכולות)

created_at, updated_at

subscriptions

id PK

business_id FK

package_id FK

מצב: status ENUM('active','past_due','canceled','trial')

חיוב חיצוני: provider='payplus', external_customer_id, external_mandate_token

תקופות: current_period_start, current_period_end

created_at, updated_at

usage_counters (ניטור תקרות)

id PK

business_id FK

period_month DATE (למשל 2025-10-01)

appointments_count INT

UNIQUE(business_id,period_month)

סניפים, עובדים ושירותים
branches

id PK

business_id FK

name, address, phone

active BOOL

שעות ייחודיות? has_custom_hours BOOL

created_at, updated_at, deleted_at

אינדקס: (business_id,active)

staff (עובדים)

id PK

business_id FK

branch_id FK (NULL=נייד/כללי)

name, email (NULL), phone

role_label (תסרוקת, עיסוי…)

calendar_color

active BOOL

חיבור יומן: calendar_provider ENUM('none','google','outlook','apple'), calendar_external_id (token/ref)

created_at, updated_at, deleted_at

אינדקס: (business_id,branch_id,active)

service_categories

id PK

business_id FK

name

position INT

UNIQUE(business_id,name)

services

id PK

business_id FK

category_id FK NULL

name

duration_min INT

price_cents INT NULL

buffer_after_min INT DEFAULT 0

description TEXT NULL

color VARCHAR(12) NULL

active BOOL

created_at, updated_at, deleted_at

אינדקס: (business_id,active,category_id)

service_staff (N:N – מי מבצע איזה שירות)

service_id FK

staff_id FK

PRIMARY KEY(service_id,staff_id)

שעות עבודה, סלוטים וחופשות
business_hours (ברירת מחדל לעסק)

id PK

business_id FK

weekday TINYINT (0=Sunday ... 6=Saturday)

open_time TIME NULL

close_time TIME NULL

active BOOL

UNIQUE(business_id,weekday)

branch_hours (אופציונלי – חורג מהעסק)

id PK

branch_id FK

weekday TINYINT

open_time TIME NULL

close_time TIME NULL

active BOOL

UNIQUE(branch_id,weekday)

staff_hours (שעות לעובד ספציפי)

id PK

staff_id FK

weekday TINYINT

open_time TIME NULL

close_time TIME NULL

active BOOL

UNIQUE(staff_id,weekday)

availability_rules (אירועים חד-פעמיים: פתוח/סגור חריג)

id PK

business_id FK

scope ENUM('business','branch','staff')

branch_id NULL, staff_id NULL

date DATE

open_time TIME NULL, close_time TIME NULL

is_open BOOL (true=שעות חריגות פתוחות, false=סגור ביום זה)

אינדקסים לפי scope

time_off (חופשות/מחלה)

id PK

business_id FK

scope ENUM('branch','staff')

branch_id NULL, staff_id NULL

start_at DATETIME, end_at DATETIME

reason VARCHAR(255) NULL

אינדקס: (business_id,start_at,end_at)

slot_policies (מדיניות סלוטים)

id PK

business_id FK

default_duration_min INT

default_gap_min INT

advance_window_days INT (כמה ימים קדימה אפשר להזמין)

same_day_booking BOOL

rounding_strategy ENUM('on_the_hour','every_15','every_30','continuous')

ניתן לאפשר overrides ברמת שירות/עובד דרך שדות בשירות/עובד אם תרצה.

לקוחות ותורים
customers (פרטי המזמין)

id PK

business_id FK

first_name, last_name

phone (חובה ב-UI), email NULL

notes TEXT NULL

created_at, updated_at

אינדקס: (business_id,phone), (business_id,email)

appointments

id PK

business_id FK

branch_id FK NULL

service_id FK

staff_id FK NULL (כש“לא משנה לי מי” – יבחר אוטומטי ואז ייקבע)

customer_id FK

start_at DATETIME, end_at DATETIME

סטטוס: status ENUM('pending','confirmed','canceled','no_show','completed') DEFAULT 'confirmed'

תשלום: price_cents INT NULL, payment_status ENUM('not_required','pending','paid','refunded') DEFAULT 'not_required', payment_provider ENUM('none','payplus')

confirmation_code VARCHAR(24) UNIQUE (למסך תודה/הדפסה)

notes_internal TEXT NULL, notes_customer TEXT NULL

מקור הזמנה: source ENUM('public','admin','api')

created_at, updated_at, canceled_at NULL

אינדקסים:

(business_id,start_at)

(business_id,staff_id,start_at)

(business_id,branch_id,start_at)

appointment_audit (לוג שינויים)

id PK

appointment_id FK

changed_by_user_id FK NULL (public=NULL)

from_json, to_json

changed_at DATETIME

אינדקס: (appointment_id,changed_at)

תשלומים (PayPlus)
payments

id PK

business_id FK

appointment_id FK NULL (תשלום לפי תור/דלפק)

provider ENUM('payplus')

external_payment_id

amount_cents

currency DEFAULT 'ILS'

status ENUM('initiated','authorized','captured','failed','refunded')

receipt_url NULL

created_at, updated_at

אינדקס: (business_id,status,created_at)

חיוב חודשי עבור חבילה מנוהל דרך subscriptions (PayPlus mandate), בעוד חיוב לפי שירות (אם תפעיל) נכנס כאן ונקשר ל-appointments.

התראות ומסרים
notification_templates

id PK

business_id FK

channel ENUM('email','sms','whatsapp')

event ENUM('booking_confirmed','booking_reminder','booking_canceled','booking_rescheduled','admin_new_booking')

subject NULL, body TEXT (תמיכה במשתנים {{customer_name}} וכו׳)

active BOOL

created_at, updated_at

UNIQUE(business_id,channel,event)

notifications (לוג שליחות)

id PK

business_id FK

appointment_id FK NULL

customer_id FK NULL

channel ENUM('email','sms','whatsapp')

event ENUM(...)

to_address (אימייל/מספר)

status ENUM('queued','sent','failed')

provider_message_id NULL

sent_at DATETIME NULL

אינדקס: (business_id,event,status,sent_at)

אינטגרציות, Webhooks, קבצים
integrations

id PK

business_id FK

type ENUM('google_calendar','microsoft_outlook','apple_calendar','webhook')

credentials_json

מצב: status ENUM('connected','error','disconnected')

created_at, updated_at

webhooks (יציאה החוצה)

id PK

business_id FK

url

secret NULL

events JSON (רשימת טריגרים: appointment.created, updated, canceled…)

active BOOL

created_at

webhook_logs

id PK

webhook_id FK

event VARCHAR(64)

payload_json

response_code

error TEXT NULL

created_at

אנליטיקות ו-SEO (אופציונלי)
public_pages

id PK

business_id FK

slug (למשל book)

title, description, theme_json (צבעים/באנר/לוגו)

created_at, updated_at

UNIQUE(business_id,slug)

events_tracking (קליקים/המרות)

id PK

business_id FK

session_id

event ENUM('view','select_branch','select_service','select_staff','slot_selected','form_submitted','booking_confirmed')

meta_json

created_at

אינדקס: (business_id,event,created_at)